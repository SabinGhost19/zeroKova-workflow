# =============================================================================
# Pipeline Summary Workflow
# Aggregates results from all CI workflows for easy monitoring
# =============================================================================

name: Pipeline Summary

on:
  # Trigger when build workflow completes
  workflow_run:
    workflows: 
      - "CI - Build & Push"
      - "CI - Security Scan"
      - "Release"
    types:
      - completed

  workflow_dispatch:

jobs:
  summary:
    name: Generate Summary
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get workflow run info
        id: workflow-info
        uses: actions/github-script@v7
        with:
          script: |
            // Get the triggering workflow run
            const triggeringWorkflow = context.payload.workflow_run;
            
            if (triggeringWorkflow) {
              core.setOutput('workflow_name', triggeringWorkflow.name);
              core.setOutput('workflow_conclusion', triggeringWorkflow.conclusion);
              core.setOutput('workflow_url', triggeringWorkflow.html_url);
              core.setOutput('head_sha', triggeringWorkflow.head_sha.substring(0, 7));
              core.setOutput('head_branch', triggeringWorkflow.head_branch);
            }
            
            // Get recent workflow runs
            const workflows = ['CI - Tests', 'CI - Build & Push', 'CI - Security Scan', 'CI - Helm Validation', 'Release'];
            const results = [];
            
            for (const workflowName of workflows) {
              try {
                const runs = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflowName.toLowerCase().replace(/ /g, '-').replace(/&/g, '').replace(/--/g, '-') + '.yaml',
                  per_page: 1
                });
                
                if (runs.data.workflow_runs.length > 0) {
                  const run = runs.data.workflow_runs[0];
                  results.push({
                    name: workflowName,
                    status: run.conclusion || run.status,
                    url: run.html_url
                  });
                }
              } catch (e) {
                console.log(`Could not fetch ${workflowName}: ${e.message}`);
              }
            }
            
            core.setOutput('workflow_results', JSON.stringify(results));

      - name: Generate Pipeline Report
        run: |
          echo "## ðŸ“Š Pipeline Status Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ steps.workflow-info.outputs.workflow_name || 'Manual' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ steps.workflow-info.outputs.head_branch || github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ steps.workflow-info.outputs.head_sha || github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Workflow Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Parse workflow results
          if [[ -n "${{ steps.workflow-info.outputs.workflow_results }}" ]]; then
            echo '${{ steps.workflow-info.outputs.workflow_results }}' | jq -r '.[] | "| \(.name) | \(if .status == "success" then "âœ…" elif .status == "failure" then "âŒ" elif .status == "in_progress" then "ðŸ”„" else "âšª" end) \(.status) |"' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
